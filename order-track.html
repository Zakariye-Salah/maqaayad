<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Order tracking- afro daafi and pizza</title>
  <link rel="stylesheet" href="style.css">
  <style>
    body{font-family:system-ui,Segoe UI,Roboto,Arial; margin:0; padding:12px; background:#f7f9fb}
    .card{background:#fff;border-radius:8px;padding:12px;box-shadow:0 6px 18px rgba(0,0,0,0.06); max-width:900px;margin:10px auto}
    .btn{display:inline-block;padding:8px 10px;border-radius:6px;border:0;cursor:pointer}
    .btn-primary{background:#0b74ff;color:#fff}
    #map{height:60vh;border-radius:8px;overflow:hidden}
  </style>
</head>
<body>
    <!-- Header Section -->
    <header>
      <div class="container header-row">
        <div class="logo">
          <img src="img/logo.png" alt="afro daafi and pizza Logo" />
          <h1>afro daafi and pizza</h1>
        </div>
    
        <!-- Mobile icons (order, shop) â€” inserted BEFORE nav to show on mobile left -->
        <div id="mobileIcons" class="mobile-icons" aria-hidden="false"></div>
    
        <nav role="navigation" aria-label="Primary">
          <ul class="nav-links">
            <li><a href="index.html">Home</a></li>
            <li><a href="menu.html">Menu</a></li>
            <li><a href="about.html">About</a></li>
            <li><a href="contact.html">Contact</a></li>
            <li><a href="order-track.html" class="active">Tracking</a></li>
    
            <!-- Desktop-visible Cart & Orders (we will hide on mobile via CSS/class) -->
            <li><a href="#" id="cartLink">Cart <span class="cart-count">0</span></a></li>
            <li><a href="#" id="orderHistoryLink">Orders</a></li>
    
            <!-- Visitor profile -->
            <li><a href="#" id="profileLink">Login</a></li>
    
            <!-- Admin dashboard (single place) + admin bell (single place) -->
            <li id="adminLi" style="display:none;"><a href="#" id="adminLink">Admin</a></li>
            <li id="orderBellLi" style="display:none;">
              <a href="#" id="orderBell" title="Admin orders" aria-label="Admin orders">
                <span class="bell-icon" aria-hidden="true">ðŸ””</span>
                <span id="orderBellCount" class="cart-count">0</span>
              </a>
            </li>
          </ul>
        </nav>
    
        <!-- hamburger injected elsewhere if you already have it; this header won't interfere -->
      </div>
    </header>
  <div class="card" id="mainCard">
    <h2>Order tracking</h2>
    <div id="status">Loading order...</div>
    <div style="margin-top:10px;">
      <button id="btnShareLocation" class="btn btn-primary">I'm the customer â€” Share my location</button>
      <button id="btnStartDelivery" class="btn" style="margin-left:8px;">I'm the rider â€” Start delivery</button>
    </div>
  </div>

  <div class="card" id="mapCard" style="display:none">
    <h3>Map</h3>
    <div id="map">Map will appear here</div>
  </div>
  <!-- Cart Modal -->
  <div class="cart-modal" id="cartModal">
    <div class="cart-content">
      <div class="cart-header">
        <h2>Your Cart</h2>
        <span class="close-btn" id="closeCart">&times;</span>
      </div>
      <div class="cart-body">
        <div id="cartItems">
          <p class="empty-cart-message">Your cart is empty</p>
        </div>
        <div class="cart-footer">
          <div class="cart-total">
            <h3>Total: $<span id="cartTotal">0.00</span></h3>
          </div>
          <button class="btn-primary checkout-btn" id="checkoutBtn">Checkout</button>
        </div>
      </div>
    </div>
  </div>

 <!-- Footer -->
 <footer>
  <div class="container">
    <div class="footer-content">
      <div class="footer-section">
        <h3>afro daafi and pizza</h3>
        <p>Delivering delicious food with love since 2025</p>
      </div>
      <div class="footer-section">
        <h3>Quick Links</h3>
        <ul>
          <li><a href="index.html">Home</a></li>
          <li><a href="menu.html">Menu</a></li>
          <li><a href="about.html">About</a></li>
          <li><a href="contact.html">Contact</a></li>
        </ul>
      </div>
      <div class="footer-section">
        <h3>Contact Us</h3>
        <p><i class="fas fa-map-marker-alt"></i> Mogadishu, Banadir region</p>
        <p><i class="fas fa-phone"></i> (123) 456-7890</p>
        <p><i class="fas fa-envelope"></i> info@foodiedelight.com</p>
      </div>
    </div>
    <div class="footer-bottom">
      <p>&copy; 2026 afro daafi and pizza. All rights reserved.</p>
    </div>
  </div>
</footer>

  
  <script type="module" src="database.js"></script>
  <script src="script.js"></script>

  <script>
    const params = new URLSearchParams(window.location.search);
    const orderParam = params.get('id') || params.get('local') || null;
    const roleParam = params.get('role') || null; // 'driver' or 'customer'
  
    // DOM refs
    const statusEl = document.getElementById('status');
    const btnShare = document.getElementById('btnShareLocation');
    const btnDriver = document.getElementById('btnStartDelivery');
  
    // hide/show buttons by role param if provided
    if (roleParam === 'driver') {
      if (btnShare) btnShare.style.display = 'none';
    } else if (roleParam === 'customer') {
      if (btnDriver) btnDriver.style.display = 'none';
    }
  
    // state
    let currentOrder = null;
    let orderDocId = null;
    let orderUnsub = null;
    let deliveryWatchId = null;
  
    async function resolveOrder(anyId) {
      // If DB helper available, try server; else fallback to localStorage
      if (!anyId) return null;
      if (window.FirebaseDB && typeof window.FirebaseDB.findOrderByAnyId === 'function') {
        try {
          const r = await window.FirebaseDB.findOrderByAnyId(anyId);
          if (r.success) {
            orderDocId = r.docId;
            return r.order;
          }
        } catch(e) { console.warn('findOrderByAnyId failed', e); }
      }
  
      // fallback local
      try {
        const localOrders = JSON.parse(localStorage.getItem('orders') || '[]');
        const found = localOrders.find(o => String(o.localId || o.remoteId || o.id || '') === String(anyId));
        if (found) {
          orderDocId = found.remoteId || found.id || null;
          return found;
        }
      } catch(e){}
      return null;
    }
  
    // subscribe to realtime order changes when we have a doc id
    function subscribeOrderRealtime(docId) {
      if (!docId || !window.FirebaseDB || typeof window.FirebaseDB.onOrderSnapshot !== 'function') return;
      // unsubscribe previous
      if (orderUnsub) try { orderUnsub(); } catch(e){}
      orderUnsub = window.FirebaseDB.onOrderSnapshot(docId, (order) => {
        currentOrder = order;
        renderOrder(order);
      });
    }
  
    function renderOrder(o) {
      if (!o) {
        statusEl.innerHTML = `<div style="color:#b00">Order ${orderParam || ''} not found.</div>`;
        return;
      }
      currentOrder = o;
      statusEl.innerHTML = `
        <div><strong>Order:</strong> ${o.id || o.localId || orderParam}</div>
        <div><strong>Customer:</strong> ${o.visitorName || 'â€”'} â€¢ ${o.phone || 'â€”'}</div>
        <div><strong>District / Area:</strong> ${o.district || 'â€”'} / ${o.area || 'â€”'}</div>
        <div><strong>Total:</strong> $${(o.total||0).toFixed(2)} â€¢ <strong>Status:</strong> ${(o.status||'pending')}</div>
        <div style="margin-top:8px; font-size:13px; color:#666;">Tap a button to share your location (will ask for permission).</div>
      `;
      // show map if locations present
      if (o.clientLocation && o.clientLocation.lat && o.clientLocation.lng) {
        // show customer location
        showMapForBoth(o.clientLocation, o.deliveryLocation);
      } else if (o.deliveryLocation && o.deliveryLocation.lat && o.deliveryLocation.lng) {
        showMapForBoth(o.clientLocation, o.deliveryLocation);
      } else {
        document.getElementById('mapCard').style.display = 'none';
      }
    }
  
    function showMapForBoth(clientLoc, deliveryLoc) {
      document.getElementById('mapCard').style.display = 'block';
      const frame = document.getElementById('map');
      // If both present, use Google Maps directions view (rider -> customer)
      if (clientLoc && clientLoc.lat && clientLoc.lng) {
        if (deliveryLoc && deliveryLoc.lat && deliveryLoc.lng) {
          const url = `https://www.google.com/maps/dir/?api=1&origin=${deliveryLoc.lat},${deliveryLoc.lng}&destination=${clientLoc.lat},${clientLoc.lng}&travelmode=driving`;
          frame.innerHTML = `<iframe src="${url}" style="width:100%; height:100%; border:0"></iframe>`;
        } else {
          const url = `https://www.google.com/maps?q=${clientLoc.lat},${clientLoc.lng}&z=16&output=embed`;
          frame.innerHTML = `<iframe src="${url}" style="width:100%; height:100%; border:0"></iframe>`;
        }
      } else if (deliveryLoc && deliveryLoc.lat && deliveryLoc.lng) {
        const url = `https://www.google.com/maps?q=${deliveryLoc.lat},${deliveryLoc.lng}&z=16&output=embed`;
        frame.innerHTML = `<iframe src="${url}" style="width:100%; height:100%; border:0"></iframe>`;
      } else {
        frame.innerHTML = `<div style="padding:12px;">Location not available yet.</div>`;
      }
    }
  
    // Fetch + subscribe
    (async function init() {
      if (!orderParam) {
        statusEl.innerHTML = '<div style="color:#666">No order ID supplied in URL.</div>';
        return;
      }
  
      // try to resolve order (local or remote)
      const order = await resolveOrder(orderParam);
      if (order) {
        renderOrder(order);
        // subscribe if we have doc id
        if (orderDocId && window.FirebaseDB && typeof window.FirebaseDB.onOrderSnapshot === 'function') {
          subscribeOrderRealtime(orderDocId);
        }
      } else {
        statusEl.innerHTML = `<div style="color:#b00">Order ${orderParam} not found.</div>`;
      }
    })();
  
  
    // ---- Customer share handler ----
    btnShare && btnShare.addEventListener('click', async () => {
      if (!navigator.geolocation) { alert('Geolocation not supported'); return; }
  
      // ensure we have a doc id to update server
      // if currentOrder has id use it; else try to resolve first
      let updateTarget = orderDocId || (currentOrder && (currentOrder.id || currentOrder.remoteId)) || null;
      if (!updateTarget) {
        // attempt to resolve before sending
        const r = await resolveOrder(orderParam);
        updateTarget = orderDocId || (r && (r.id || r.remoteId)) || null;
      }
  
      navigator.geolocation.getCurrentPosition(async (pos) => {
        const lat = pos.coords.latitude, lng = pos.coords.longitude;
        // local update for visitor copy
        try {
          const localOrders = JSON.parse(localStorage.getItem('orders') || '[]');
          const idx = localOrders.findIndex(lo => String(lo.localId || lo.remoteId || lo.id || '') === String(orderParam));
          if (idx !== -1) {
            localOrders[idx].clientLocation = { lat, lng, ts: Date.now() };
            localStorage.setItem('orders', JSON.stringify(localOrders));
          }
        } catch (e) { console.warn('local save failed', e); }
  
        // server update (resolves doc id inside)
        if (window.FirebaseDB && typeof window.FirebaseDB.updateOrderLocation === 'function') {
          try {
            const upd = await window.FirebaseDB.updateOrderLocation(updateTarget || orderParam, { lat, lng });
            if (upd && upd.success) {
              showMapForBoth({lat,lng}, currentOrder && currentOrder.deliveryLocation ? currentOrder.deliveryLocation : null);
              showToast && showToast('Location shared');
            } else {
              console.warn('updateOrderLocation returned:', upd);
              showToast && showToast('Could not send location to server (still shared locally).');
            }
          } catch (err) {
            console.warn('updateOrderLocation failed', err);
            showToast && showToast('Failed to send location to server.');
          }
        } else {
          // no server helper: shared only locally
          showMapForBoth({lat,lng}, currentOrder && currentOrder.deliveryLocation ? currentOrder.deliveryLocation : null);
          showToast && showToast('Location saved locally (no server).');
        }
      }, (err) => {
        alert('Unable to get location â€” please allow location permission.');
      }, { enableHighAccuracy:true, timeout:15000 });
    });
  
  
    // ---- Driver start delivery (continuous watch) ----
    btnDriver && btnDriver.addEventListener('click', async () => {
      if (!navigator.geolocation) { alert('Geolocation not supported'); return; }
      if (!confirm('Start sharing your location for this delivery?')) return;
      // resolve target doc id
      const target = orderDocId || (currentOrder && (currentOrder.id || currentOrder.remoteId)) || orderParam;
  
      if (!window.FirebaseDB || typeof window.FirebaseDB.updateDeliveryLocation !== 'function') {
        showToast && showToast('Server delivery helper not available. Coordinates will be stored locally only.');
      }
  
      if (deliveryWatchId !== null) {
        showToast && showToast('Already sharing location');
        return;
      }
  
      deliveryWatchId = navigator.geolocation.watchPosition(async (pos) => {
        const lat = pos.coords.latitude, lng = pos.coords.longitude;
        // update server if helper exists (resolves doc id if required)
        if (window.FirebaseDB && typeof window.FirebaseDB.updateDeliveryLocation === 'function') {
          try {
            await window.FirebaseDB.updateDeliveryLocation(target || orderParam, { lat, lng });
          } catch(e){ console.warn('updateDeliveryLocation failed', e); }
        } else {
          // store local fallback so admin who uses same device can see it
          localStorage.setItem('delivery_' + (orderParam||'unknown'), JSON.stringify({ lat, lng, ts:Date.now() }));
        }
        // update map to show delivery position too
        const clientLoc = currentOrder && currentOrder.clientLocation ? currentOrder.clientLocation : null;
        showMapForBoth(clientLoc, {lat,lng});
      }, (err) => {
        console.warn('watchPosition error', err);
        alert('Unable to watch position. Please allow location and ensure GPS is ON.');
      }, { enableHighAccuracy:true, maximumAge:2000, timeout:10000 });
  
      showToast && showToast('Delivery location sharing started. Keep this page open.');
    });
  
  </script>
  
</body>
</html>
