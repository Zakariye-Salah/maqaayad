<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin Dashboard - afro daafi and pizza</title>
  <link rel="stylesheet" href="style.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <style>
    /* small admin page styles */
    body { background:#f6f7fb; font-family: Arial, sans-serif; }
    .admin-wrap { max-width:1100px; margin:24px auto; padding:12px; }
    .admin-row { display:flex; gap:12px; align-items:center; margin-bottom:12px; flex-wrap:wrap; }
    .card { background:#fff; border:1px solid #eee; padding:12px; border-radius:8px; box-shadow:0 2px 6px rgba(0,0,0,0.03); }
    #ordersList .order { border-bottom:1px solid #f0f0f0; padding:12px 0; }
    .status-pill { padding:6px 8px; border-radius:6px; font-weight:600; font-size:13px; }
    .status-pending { background:#fff3cd; color:#8a6d1b; }
    .status-confirmed { background:#d4edda; color:#155724; }
    .status-denied { background:#f8d7da; color:#721c24; }
    .status-delivered { background:#cce5ff; color:#0b3d91; }
    .btn-small { padding:6px 8px; border-radius:6px; margin-right:6px; cursor:pointer; border:1px solid #ddd; background:#fafafa; }
    .search-input { padding:8px; width:280px; border-radius:6px; border:1px solid #ddd; }
    .filters { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .profile-box { margin-left:auto; }
    .hidden { display:none; }

    /* period totals */
    .totals-row { display:flex; gap:12px; margin-top:12px; align-items:center; flex-wrap:wrap; }
    .tot-card { padding:10px 12px; border-radius:8px; background:#fff; box-shadow:0 1px 4px rgba(0,0,0,0.04); border:1px solid #eee; min-width:160px; }
    .tot-card h4 { margin:0 0 6px 0; font-size:14px; color:#444; }
    .tot-card p { margin:0; font-weight:700; font-size:18px; }

    /* order view modal */
    .modal-backdrop { position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,0.4); z-index:9999; }
    .modal { width:90%; max-width:720px; background:#fff; border-radius:8px; overflow:hidden; }
    .modal-header { padding:12px 16px; border-bottom:1px solid #eee; display:flex; align-items:center; justify-content:space-between; }
    .modal-body { padding:16px; max-height:70vh; overflow:auto; }
    .modal-footer { padding:12px 16px; border-top:1px solid #eee; text-align:right; }
    .order-items { margin:8px 0; }
    .order-items li { margin-bottom:6px; }

    #periodTotals .tot-card:nth-child(1) { background:#eef2ff; color:#1e3a8a; }
#periodTotals .tot-card:nth-child(2) { background:#ecfdf5; color:#065f46; }
#periodTotals .tot-card:nth-child(3) { background:#e0f2fe; color:#075985; }
#periodTotals .tot-card:nth-child(4) { background:#fff7ed; color:#9a3412; }

#periodTotals .tot-card p {
  font-size:22px;
}

/* Responsive admin profile fixes (mobile-first improvements) */
@media (max-width: 992px) {
  .admin-wrap { padding: 10px; }

  /* make the admin card area wrap cleanly */
  .admin-row > .card { width: 100%; }

  /* Ensure the filters area stacks on smaller screens */
  .admin-row > .card > div { flex-direction: column; align-items: stretch; gap: 10px; }

  /* Profile box: full width, visually separated and placed first */
  #adminProfileBox {
    order: -1;                /* place it first within the flex row on small screens */
    width: 100% !important;
    margin-left: 0 !important;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 10px;
    box-sizing: border-box;
    padding: 10px;
  }

  /* Admin info block inside profile-box */
  #adminProfileBox #adminInfo {
    flex: 1 1 auto;
    min-width: 0;
    line-height: 1.2;
    word-break: break-word;
  }

  /* Ensure actions group lays out nicely */
  #adminProfileBox .profile-actions {
    display: flex;
    gap: 8px;
    align-items: center;
    flex: 0 0 auto;
  }

  /* Smaller screens: stack actions vertically and make buttons full width */
  @media (max-width: 480px) {
    #adminProfileBox {
      flex-direction: column;
      align-items: stretch;
    }
    #adminProfileBox .profile-actions {
      flex-direction: row;
      justify-content: flex-end;
      gap: 8px;
      flex-wrap: wrap;
    }
    #adminProfileBox .profile-actions .btn-small {
      min-width: 48%;
      padding: 8px 10px;
      box-sizing: border-box;
    }
    /* if you prefer fully stacked buttons on tiny devices, uncomment:
    #adminProfileBox .profile-actions { flex-direction: column; }
    #adminProfileBox .profile-actions .btn-small { width:100%; }
    */
  }

  /* Make export menu not overlap profile on small screens */
  #exportMenu { right: 8px; left: auto; top: 44px; }
}

/* Improve modal sizing for very small devices */
@media (max-width: 480px) {
  .modal { width: 96%; max-width: 96%; }
}

.status-pending {
  border-left: 4px solid #e74c3c;
  background: #fff6f6;
}

/* product card tweaks */
#productsList .order {
  border: 1px solid #eee;
  background: #fff;
  border-radius: 8px;
  padding: 10px;
  transition: box-shadow .12s ease;
}
#productsList .order:hover { box-shadow: 0 6px 18px rgba(15,23,42,0.06); }
#productsList img { border-radius:6px; display:block; }
#productsList .btn-small { font-size:13px; padding:6px 8px; }
#productFormWrap { background:#fff; border:1px solid #eee; padding:12px; border-radius:8px; }

/* responsive recipients list */
.rec-row { display:flex; align-items:center; gap:10px; padding:10px; border-bottom:1px solid #eee; }
.rec-col { flex:1; }
.rec-actions { display:flex; gap:6px; }

@media (max-width: 768px) { 
  .rec-hide-mobile { display:none !important; }
  .rec-actions button:not(.btn-view) { display:none !important; }
}


  </style>
</head>
<body>
    <!-- Header Section -->
<header>
  <div class="container header-row">
    <div class="logo">
      <img src="img/logo.png" alt="afro daafi and pizza Logo" />
      <h1>afro daafi and pizza</h1>
    </div>

    <!-- Mobile icons (order, shop) â€” inserted BEFORE nav to show on mobile left -->
    <div id="mobileIcons" class="mobile-icons" aria-hidden="false"></div>

    <nav role="navigation" aria-label="Primary">
      <ul class="nav-links">
        <li><a href="index.html">Home</a></li>
        <li><a href="menu.html">Menu</a></li>
        <li><a href="about.html">About</a></li>
        <li><a href="contact.html">Contact</a></li>
        <li><a href="order-track.html">Tracking</a></li>

        <!-- Desktop-visible Cart & Orders (we will hide on mobile via CSS/class) -->
        <li><a href="#" id="cartLink">Cart <span class="cart-count">0</span></a></li>
        <li><a href="#" id="orderHistoryLink">Orders</a></li>

        <!-- Visitor profile -->
        <li><a href="#" id="profileLink">Login</a></li>

        <!-- Admin dashboard (single place) + admin bell (single place) -->
        <li id="adminLi" style="display:none;"><a href="#" id="adminLink">Admin</a></li>
        <li id="orderBellLi" style="display:none;">
          <a href="#" id="orderBell" title="Admin orders" aria-label="Admin orders">
            <span class="bell-icon" aria-hidden="true">ðŸ””</span>
            <span id="orderBellCount" class="cart-count">0</span>
          </a>
        </li>
      </ul>
    </nav>

    <!-- hamburger injected elsewhere if you already have it; this header won't interfere -->
  </div>
</header>
<!-- ===== end header ===== -->

  <div class="admin-wrap">

    <div class="admin-row">
      <div class="card" style="flex:1;">
        <div style="display:flex; gap:12px; align-items:center; width:100%;">
        

          <div class="filters" style="flex:1;">
            <!-- Period selector (new) -->
            <select id="periodSelect" class="search-input" style="width:160px;">
              <option value="today">Today</option>
              <option value="week">This week</option>
              <option value="month">This month</option>
              <option value="year">This year</option>
              <option value="all">All</option>
            </select>

     

            <select id="statusFilter">
              <option value="pending">Pending</option>
              <option value="all">All statuses</option>
              <option value="confirmed">Confirmed</option>
              <option value="delivered">Delivered</option>
              <option value="denied">Denied</option>
            </select>

            <div style="position:relative;">
              <button id="exportBtn" class="btn-small card">
                Export <i class="fa fa-caret-down"></i>
              </button>
              <div id="exportMenu" class="card hidden" style="position:absolute; right:0; top:40px; min-width:120px; z-index:99;">
                <button class="btn-small" data-export="csv">Export CSV</button><br>
                <button class="btn-small" data-export="pdf">Export PDF</button>
              </div>
            </div>
            
            <!-- <button id="refreshBtn" class="btn-small card">Refresh</button> -->

            <button id="contactsTab" class="btn-small">
              Contacts
              <span id="contactsUnread" class="cart-count">0</span>
            </button>
            
            <!-- Search that will apply within the selected period -->
            <input id="searchInput" class="search-input" placeholder="Search by name, phone, id, district..." />
            <!-- <input id="contactsSearch" placeholder="Search name / phone / email"> -->

            <button id="refreshBtn" class="btn-small card">
              <i class="fa fa-refresh"></i>
            </button>
            
            
            <div id="contactsList"></div>

          </div>

          <div class="profile-box card" id="adminProfileBox">
            <div id="adminInfo">Not signed in</div>
            <div style="margin-top:8px;">
              <button id="openProfileBtn" class="btn-small">Edit Profile</button>
              <button id="adminLogoutBtn" class="btn-small">Logout</button>
            </div>
          </div>
        </div>

        <!-- Totals panel (new) -->
        <div class="totals-row" style="margin-top:12px;" id="periodTotals">
          <div class="tot-card">
            <h4>Orders (selected)</h4>
            <p id="totAll">0</p>
          </div>
          <div class="tot-card">
            <h4>Confirmed</h4>
            <p id="totConfirmed">0</p>
          </div>
          <div class="tot-card">
            <h4>Delivered</h4>
            <p id="totDelivered">0</p>
          </div>
          <div class="tot-card">
            <h4>Revenue (confirmed+delivered)</h4>
            <p id="totMoney">$0.00</p>
          </div>
        </div>

      </div>
    </div>
    <!-- add next to your Contacts button -->
<!-- Replace your old tabs block with this -->
<button id="tabOrders" class="btn-small active">Orders Online</button>
<button id="tabRecipients" class="btn-small">Recipients</button>

<!-- Top-level New Recipient (hidden until Recipients tab clicked) -->
<button id="newRecipientTopBtn" class="btn-small" style="margin-left:8px; display:none;">+ New Recipient</button>

<!-- Quick search (hidden until Recipients tab clicked) -->
<input id="recipientTopSearch" placeholder="Search table # or receipt id (e.g. 12345678-ADM)"
       style="margin-left:12px; padding:8px; border-radius:6px; border:1px solid #ddd; min-width:260px; display:none;">

<select id="periodSelect" class="search-input" style="width:160px; display:none;">
  <option value="today" selected>Today</option>
  <option value="week">This week</option>
  <option value="month">This month</option>
  <option value="year">This year</option>
  <option value="all">All</option>
</select>

<div style="position:relative; display:none;" id="exportWrapper">
  <button id="exportBtn" class="btn-small card">Export <i class="fa fa-caret-down"></i></button>
  <div id="exportMenu" class="card hidden" style="position:absolute; right:0; top:40px; min-width:160px; z-index:99; display:none;">
    <button class="btn-small export-action" data-type="csv">Export CSV</button><br>
    <button class="btn-small export-action" data-type="pdf">Export PDF</button><br>
    <button class="btn-small export-action" data-type="xls">Export Excel</button>
  </div>
</div>

<!-- Totals summary (subtotal-only + count) -->
<div id="totalsSummary" style="margin-left:12px; display:none; align-items:center;">
  <div style="background:#fff;padding:8px;border-radius:8px;display:flex;gap:10px;align-items:center;">
    <div style="font-size:13px;color:#666">Total (<span id="totLabel">Today</span>)</div>
    <div style="font-weight:800" id="totSubtotalAmount">$0.00</div>
    <div style="color:#666">( <span id="totSubtotalCount">0</span> )</div>
  </div>
</div>


</div>





    <div id="ordersList" class="card" style="margin-top:12px;">
      Loading orders...
    </div>
  </div>

  <!-- Order View Modal (hidden until used) -->
  <div id="orderViewModal" class="modal-backdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="orderViewTitle">
      <div class="modal-header">
        <div>
          <h3 id="orderViewTitle">Order</h3>
          <small id="orderViewSub"></small>
        </div>
        <div><button id="closeOrderView" class="btn-small">Close</button></div>
      </div>
      <div class="modal-body" id="orderViewBody">
        <!-- details injected here -->
      </div>
      <div class="modal-footer" id="orderViewFooter">
        <!-- actions injected here -->
      </div>
    </div>
  </div>

    <!-- Cart Modal -->
    <div class="cart-modal" id="cartModal">
      <div class="cart-content">
        <div class="cart-header">
          <h2>Your Cart</h2>
          <span class="close-btn" id="closeCart">&times;</span>
        </div>
        <div class="cart-body">
          <div id="cartItems">
            <p class="empty-cart-message">Your cart is empty</p>
          </div>
          <div class="cart-footer">
            <div class="cart-total">
              <h3>Total: $<span id="cartTotal">0.00</span></h3>
            </div>
            <button class="btn-primary checkout-btn" id="checkoutBtn">Checkout</button>
          </div>
        </div>
      </div>
    </div>


 <!-- Footer -->
 <footer>
  <div class="container">
    <div class="footer-content">
      <div class="footer-section">
        <h3>afro daafi and pizza</h3>
        <p>Delivering delicious food with love since 2025</p>
      </div>
      <div class="footer-section">
        <h3>Quick Links</h3>
        <ul>
          <li><a href="index.html">Home</a></li>
          <li><a href="menu.html">Menu</a></li>
          <li><a href="about.html">About</a></li>
          <li><a href="contact.html">Contact</a></li>
        </ul>
      </div>
      <div class="footer-section">
        <h3>Contact Us</h3>
        <p><i class="fas fa-map-marker-alt"></i> Mogadishu, Banadir region</p>
        <p><i class="fas fa-phone"></i> (123) 456-7890</p>
        <p><i class="fas fa-envelope"></i> info@foodiedelight.com</p>
      </div>
    </div>
    <div class="footer-bottom">
      <p>&copy; 2026 afro daafi and pizza. All rights reserved.</p>
    </div>
  </div>
</footer>

  <!-- Firebase DB module -->
  <script type="module" src="database.js"></script>
  <script type="module" src="admin.js"></script>
  <script src="script.js"></script>
  
  <script>
    (function() {
      // Wait for DOM ready
      document.addEventListener('DOMContentLoaded', () => {
        const profileBox = document.getElementById('adminProfileBox');
        if (!profileBox) return;
    
        // Save original placement so we can restore on large screens
        const originalParent = profileBox.parentNode;
        const originalNext = profileBox.nextElementSibling;
    
        // Ensure buttons are inside .profile-actions (so CSS can target them)
        let actions = profileBox.querySelector('.profile-actions');
        if (!actions) {
          actions = document.createElement('div');
          actions.className = 'profile-actions';
          // move all direct child buttons into actions
          const buttons = Array.from(profileBox.querySelectorAll('button'));
          buttons.forEach(btn => actions.appendChild(btn));
          profileBox.appendChild(actions);
        }
    
        // reposition helper
        function layoutForWidth(w) {
          const wrap = document.querySelector('.admin-wrap');
          if (!wrap) return;
          if (w <= 992) {
            // place profileBox at the top of .admin-wrap (first child)
            if (profileBox.parentNode !== wrap) wrap.insertBefore(profileBox, wrap.firstChild);
          } else {
            // restore original location (if still in DOM)
            if (profileBox.parentNode !== originalParent) {
              if (originalNext && originalNext.parentNode === originalParent) {
                originalParent.insertBefore(profileBox, originalNext);
              } else {
                originalParent.appendChild(profileBox);
              }
            }
          }
        }
    
        // initial layout
        layoutForWidth(window.innerWidth);
    
        // react to resize
        let resizeTO;
        window.addEventListener('resize', () => {
          clearTimeout(resizeTO);
          resizeTO = setTimeout(() => layoutForWidth(window.innerWidth), 120);
        });
      });
    })();
    </script>
    <script>
      // small helper to wait for FirebaseDB to be ready
      async function waitForFirebaseDB(ms = 5000) {
        const start = Date.now();
        while (!window.FirebaseDB && Date.now() - start < ms) {
          await new Promise(r => setTimeout(r, 150));
        }
        return !!window.FirebaseDB;
      }
      
      // subscribe to auth/admin state and set window.currentAdmin
      (async function initAdminWatcher() {
        const ok = await waitForFirebaseDB(5000);
        if (!ok) {
          console.warn('FirebaseDB not ready for admin watcher');
          return;
        }
      
        // onAuthStateChange should call callback with null or { uid, email, adminDoc }
        if (typeof window.FirebaseDB.onAuthStateChange === 'function') {
          window.FirebaseDB.onAuthStateChange((user) => {
            // store globally so other scripts can check
            window.currentAdmin = user;
            console.log('onAuthStateChange -> currentAdmin =', user);
            // UI updates: show admin links / enable product actions
            const productsBtn = document.getElementById('productsTab');
            const adminLink = document.getElementById('adminLink');
            if (user && user.adminDoc) {
              // user is authenticated & listed as admin in your admins/admin collection
              if (productsBtn) { productsBtn.disabled = false; productsBtn.style.display = ''; }
              if (adminLink) adminLink.style.display = '';
            } else {
              // not admin or logged out
              if (productsBtn) { productsBtn.disabled = true; /* keep visible but disabled if you prefer */ }
              if (adminLink) adminLink.style.display = 'none';
            }
          });
        } else {
          console.warn('FirebaseDB.onAuthStateChange not available â€” ensure database.js exposes it');
        }
      })();
      </script>
      
  
      </body>
</html>
